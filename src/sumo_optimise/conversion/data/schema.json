{
  "$schema": "https://json-schema.org/draft-07/schema",
  "$id": "https://example.org/sumo-linear-corridor.v1_4.schema.json",
  "title": "SUMO Linear Corridor Network Specification (v1.4)",
  "type": "object",
  "additionalProperties": false,
  "description": "単一の一直線の路線に、T字路/十字路と単路部横断を配置する指示書の仕様。",
  "$comment": "LHT(左側通行)が前提。pos_mの上限（main_road.length_m以内）や交差点と横断歩道の衝突など、指示書の内容が正しい(valid)かどうか、指示書を受け取った側で確認すること。",
  "properties": {
    "version": { "type": "string", "const": "1.4"},

    "snap": {
      "type": "object",
      "description": "交差点や横断歩道といったイベントの位置 pos_m は、一定の間隔の点状に丸める。その丸めの規則。",
      "additionalProperties": false,
      "properties": {
        "step_m": { "type": "integer", "minimum": 1, "description": "丸め単位[m]" },
        "tie_break": {
          "type": "string",
          "enum": ["toward_west", "toward_east"],
          "description": "丸めがちょうど真ん中になったときに優先する方向。丸め以外でも、位置が衝突したときの検査などで使用する"
        }
      },
      "required": ["step_m", "tie_break"]
    },

    "defaults": {
      "type": "object",
      "description": "既定値",
      "additionalProperties": false,
      "properties": {
        "minor_road_length_m": { "type": "integer", "minimum": 1, "description": "従道路を交差点中心から伸ばす長さ[m]" },
        "ped_crossing_width_m": { "type": "number", "minimum": 1, "description": "横断歩道の幅[m]" },
        "ped_endpoint_offset_m": {
          "type": "number",
          "minimum": 0,
          "description": "歩行者のspawn/arrival位置でエッジ端から離す距離[m]",
          "default": 0.1
        },
        "sidewalk_width_m": { "type": "number", "minimum": 0, "description": "道路脇の歩道の幅[m]" },
        "speed_kmh": { "type": "integer", "exclusiveMinimum": 0, "description": "制限速度[km/h]" },
        "junction_radius_m": {
          "type": "number",
          "minimum": 0,
          "description": "交差点の半径[m]",
          "default": 4
        }
      },
      "required": ["minor_road_length_m", "ped_crossing_width_m", "speed_kmh"]
    },

    "main_road": {
      "type": "object",
      "description": "主道路は東西に走る2本の一方通行のペア。うち北側がEB(East Bound)、南側がWB(West Bound)。設定は両方向共通。",
      "additionalProperties": false,
      "properties": {
        "length_m": { "type": "integer", "exclusiveMinimum": 0, "description": "主道路の延長[m]" },
        "center_gap_m": { "type": "number", "minimum": 0, "description": "EBとWBの間隔[m]" },
        "lanes": { "type": "integer", "minimum": 1, "description": "レーン数" }
      },
      "required": ["length_m", "center_gap_m", "lanes"]
    },

    "signal_profiles": {
      "type": "object",
      "description": "定周期の信号プロファイル（種別別の集合）。",
      "additionalProperties": false,
      "properties": {
        "tee": {
          "type": "array",
          "items": { "$ref": "#/definitions/signalProfile" },
          "description": "T字路用プロファイル"
        },
        "cross": {
          "type": "array",
          "items": { "$ref": "#/definitions/signalProfile" },
          "description": "十字路用プロファイル"
        },
        "xwalk_midblock": {
          "type": "array",
          "items": { "$ref": "#/definitions/signalProfileMidblock" },
          "description": "単路部横断用プロファイル"
        }
      },
      "required": ["tee", "cross", "xwalk_midblock"]
    },

    "layout": {
      "type": "array",
      "description": "主道路上のイベント列（起点=西端=0m）。各要素は tee / cross / xwalk_midblock のいずれか。",
      "items": {
        "oneOf": [
          { "$ref": "#/definitions/layoutXwalkMidblock" },
          { "$ref": "#/definitions/layoutTee" },
          { "$ref": "#/definitions/layoutCross" }
        ]
      }
    }
  },

  "required": [
    "version",
    "snap",
    "defaults",
    "main_road",
    "signal_profiles",
    "layout"
  ],

  "definitions": {
    "idString": {
      "type": "string",
      "pattern": "^[A-Za-z0-9._-]+$",
      "description": "英数・._- のみ"
    },

    "movementString": {
      "type": "string",
      "pattern": "^(?:PedX(?:_[NESW]+|_(?:N|S)_(?:E|W)-half|_(?:E|W)_(?:N|S)-half)?|[NESW]B_[LTRU]{1,4}(?:_p[gr])?)$",
      "description": "車両: {N|E|S|W}B_{L|T|R|U}（順不同で1〜4文字、重複不可）＋任意の _p{r|g}。歩行者: PedX（全方向一括）、PedX_{N|E|S|W…}（順不同で複数方角指定）、PedX_{N|S}_{E|W-half}、または PedX_{E|W}_{N|S-half}。"
    },
    "midblockMovementString": {
      "type": "string",
      "pattern": "^(EB|WB|PedX|PedX_N|PedX_S)$",
      "description": "単路部横断TLの許容トークン。車両は主道路の EB/WB のみ、歩行者は全体(PedX)または片側(PedX_N/PedX_S)のみ。"
    },
    "signalPhase": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "duration_s": { "type": "integer", "minimum": 1, "description": "フェーズ長[秒]" },
        "allow_movements": {
          "type": "array",
          "items": { "$ref": "#/definitions/movementString" },
          "uniqueItems": true,
          "description": "当該フェーズで許可する動作の集合。未指定時は空配列=全赤扱い。"
        }
      },
      "required": ["duration_s", "allow_movements"]
    },
    "signalPhaseMidblock": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "duration_s": { "type": "integer", "minimum": 1, "description": "フェーズ長[秒]" },
        "allow_movements": {
          "type": "array",
          "items": { "$ref": "#/definitions/midblockMovementString" },
          "uniqueItems": true,
          "description": "単路部横断で許可する動作（EB/WB/PedX/PedX_N/PedX_S のみ）。未指定時は全赤扱い。"
        }
      },
      "required": ["duration_s", "allow_movements"]
    },

    "signalRef": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "profile_id": { "$ref": "#/definitions/idString", "description": "適用する信号プロファイルID（種別に対応）" },
        "offset_s": { "type": "integer", "minimum": 0, "description": "交差点ローカルの時差[秒]（<tlLogic offset>に相当）" }
      },
      "required": ["profile_id", "offset_s"]
    },

    "mainPedCrossingPlacement": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "west": { "type": "boolean", "description": "交差点の西側の主道路を渡る横断歩道を設置するか" },
        "east": { "type": "boolean", "description": "交差点の東側の主道路を渡る横断歩道を設置するか" }
      },
      "required": ["west", "east"],
      "description": "交差点における主道路横断歩道の設置有無（東西）。"
    },

    "laneMovementLabel": {
      "type": "string",
      "pattern": "^[LTRU]+$",
      "description": "レーンに許可する動作（L/T/R/Uの組み合わせ、順不同）"
    },
    "laneMovementTemplate": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/laneMovementLabel" },
      "description": "左端→右端の順に並べたレーン指定。配列の長さが対象レーン数。"
    },
    "laneMovementProfiles": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/laneMovementTemplate" },
      "description": "レーン数ごとに複数のテンプレートを並べる。"
    },
    "laneMovements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "main": { "$ref": "#/definitions/laneMovementProfiles", "description": "主道路（EB/WB共通）の流入レーン指定" },
        "EB": { "$ref": "#/definitions/laneMovementProfiles", "description": "主道路 EB の流入レーン指定" },
        "WB": { "$ref": "#/definitions/laneMovementProfiles", "description": "主道路 WB の流入レーン指定" },
        "minor": { "$ref": "#/definitions/laneMovementProfiles", "description": "従道路（北南共通）の流入レーン指定" },
        "NB": { "$ref": "#/definitions/laneMovementProfiles", "description": "従道路 NB の流入レーン指定" },
        "SB": { "$ref": "#/definitions/laneMovementProfiles", "description": "従道路 SB の流入レーン指定" }
      },
      "description": "交差点流入レーンの進行方向を手動指定するための設定。レーン数に応じて一致するテンプレートが適用され、見つからない場合は従来の自動割当を使用する。"
    },

    "signalProfileBase": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "id": { "$ref": "#/definitions/idString", "description": "信号プロファイルID" },
        "cycle_s": { "type": "integer", "minimum": 1, "description": "サイクル長[秒]（phases.duration_s の総和と一致）" },
        "ped_early_cutoff_s": {
          "type": "integer",
          "minimum": 0,
          "description": "歩行者横断信号を車両より先行して赤に切り替える時間[秒]"
        },
        "yellow_duration_s": {
          "type": "integer",
          "minimum": 1,
          "description": "車両現示が赤に変わる直前、連続した青現示の末尾と入れ替える黄現示時間[秒]。複数フェーズにまたがって青が継続する場合は赤に切り替わるまでの青時間を合算し、その末尾 yellow_duration_s 秒を黄色にする。"
        },
        "phases": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/signalPhase" },
          "description": "固定時間フェーズ列。黄色相はJSONでは表現しない。"
        }
      },
      "required": ["id", "cycle_s", "yellow_duration_s", "phases"],
      "description": "固定時間信号の定義。"
    },

    "signalProfile": {
      "allOf": [
        { "$ref": "#/definitions/signalProfileBase" },
        { "required": ["ped_early_cutoff_s"] }
      ]
    },

    "signalProfileMidblock": {
      "allOf": [
        {
          "type": "object",
          "properties": {
            "id": { "$ref": "#/definitions/idString" },
            "cycle_s": { "type": "integer", "minimum": 1 },
            "ped_early_cutoff_s": {
              "type": "integer",
              "minimum": 0,
              "description": "歩行者横断信号を車両より先行して赤に切り替える時間[秒]"
            },
            "yellow_duration_s": {
              "type": "integer",
              "minimum": 1,
              "description": "車両現示切替時の黄現示時間[秒]"
            },
            "phases": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/definitions/signalPhaseMidblock" },
              "description": "単路部横断用フェーズ列（車両=EB/WB、歩行者=PedX/PedX_N/PedX_S のサブセットのみ）。"
            }
          },
          "required": ["id", "cycle_s", "ped_early_cutoff_s", "yellow_duration_s", "phases"]
        }
      ],
      "description": "単路部横断用信号プロファイル。歩行者競合は設定不可。"
    },

    "layoutTee": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "tee", "description": "イベント種別＝T字路" },
        "pos_m": { "type": "number", "minimum": 0, "description": "主道路起点からの位置[m]" },
        "branch": { "type": "string", "enum": ["north", "south"], "description": "従道路の方向" },
        "main_approach_begin_m": {
          "type": "integer",
          "minimum": 0,
          "description": "交差点上流で主道路レーン数を切り替える距離[m]（0=変更区間なし）"
        },
        "main_approach_lanes": {
          "type": "integer",
          "minimum": 0,
          "description": "アプローチ区間の主道路レーン数（0=基準レーン数を維持）"
        },
        "minor_lanes_approach": { "type": "integer", "minimum": 1, "description": "従道路→主道路のレーン数" },
        "minor_lanes_departure": { "type": "integer", "minimum": 1, "description": "主道路→従道路のレーン数" },
        "median_continuous": {
          "type": "boolean",
          "description": "中央帯(median)が交差点内まで連続しているか（右折/Uターン制限を伴う）"
        },
        "lane_movements": {
          "$ref": "#/definitions/laneMovements",
          "description": "流入レーンの進行方向を手動で指定する（main/EB/WB/minor/NB/SB のいずれかを使用）。"
        },
        "main_u_turn_allowed": {
          "type": "boolean",
          "description": "主道路のUターンを許可するか（true=許可、false=禁止）"
        },
        "refuge_island_on_main": {
          "type": "boolean",
          "description": "主道路横断に歩行者退避スペース（refuge island）を設けるか"
        },
        "signalized": { "type": "boolean", "description": "信号の有無" },
        "two_stage_tll_control": {
          "type": "boolean",
          "description": "refuge island を設けた信号交差点で二段階横断信号制御(two-stage TLL)の有無を指定（signalized=true かつ refuge_island_on_main=true の場合のみ必須）"
        },
        "signal": { "$ref": "#/definitions/signalRef" },
        "main_ped_crossing_placement": { "$ref": "#/definitions/mainPedCrossingPlacement" }
      },
      "required": [
        "type",
        "pos_m",
        "branch",
        "main_approach_begin_m",
        "main_approach_lanes",
        "minor_lanes_approach",
        "minor_lanes_departure",
        "median_continuous",
        "main_u_turn_allowed",
        "signalized",
        "main_ped_crossing_placement",
        "refuge_island_on_main"
      ],
      "allOf": [
        { "if": { "properties": { "signalized": { "const": true } }, "required": ["signalized"] }, "then": { "required": ["signal"] } },
        { "if": { "properties": { "signalized": { "const": false } }, "required": ["signalized"] }, "then": { "not": { "required": ["signal"] } } },
        {
          "if": {
            "properties": {
              "signalized": { "const": true },
              "refuge_island_on_main": { "const": true }
            },
            "required": ["signalized", "refuge_island_on_main"]
          },
          "then": { "required": ["two_stage_tll_control"] },
          "else": { "not": { "required": ["two_stage_tll_control"] } }
        }
      ],
      "description": "T字路イベント。幾何形状はテンプレートで、主道路横断のrefuge islandや制御はイベントごとに指定する。"
    },

    "layoutCross": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "cross", "description": "イベント種別＝十字路" },
        "pos_m": { "type": "number", "minimum": 0, "description": "主道路起点からの位置[m]" },
        "main_approach_begin_m": {
          "type": "integer",
          "minimum": 0,
          "description": "交差点上流で主道路レーン数を切り替える距離[m]（0=変更区間なし）"
        },
        "main_approach_lanes": {
          "type": "integer",
          "minimum": 0,
          "description": "アプローチ区間の主道路レーン数（0=基準レーン数を維持）"
        },
        "minor_lanes_approach": { "type": "integer", "minimum": 1, "description": "従道路→主道路のレーン数" },
        "minor_lanes_departure": { "type": "integer", "minimum": 1, "description": "主道路→従道路のレーン数" },
        "median_continuous": {
          "type": "boolean",
          "description": "中央帯(median)が交差点内まで連続しているか（右折/Uターン制限を伴う）"
        },
        "lane_movements": {
          "$ref": "#/definitions/laneMovements",
          "description": "流入レーンの進行方向を手動で指定する（main/EB/WB/minor/NB/SB のいずれかを使用）。"
        },
        "main_u_turn_allowed": {
          "type": "boolean",
          "description": "主道路のUターンを許可するか（true=許可、false=禁止）"
        },
        "refuge_island_on_main": {
          "type": "boolean",
          "description": "主道路横断に歩行者退避スペース（refuge island）を設けるか"
        },
        "signalized": { "type": "boolean", "description": "信号の有無" },
        "two_stage_tll_control": {
          "type": "boolean",
          "description": "refuge island を設けた信号交差点で二段階横断信号制御(two-stage TLL)の有無を指定（signalized=true かつ refuge_island_on_main=true の場合のみ必須）"
        },
        "signal": { "$ref": "#/definitions/signalRef" },
        "main_ped_crossing_placement": { "$ref": "#/definitions/mainPedCrossingPlacement" }
      },
      "required": [
        "type",
        "pos_m",
        "main_approach_begin_m",
        "main_approach_lanes",
        "minor_lanes_approach",
        "minor_lanes_departure",
        "median_continuous",
        "main_u_turn_allowed",
        "signalized",
        "main_ped_crossing_placement",
        "refuge_island_on_main"
      ],
      "allOf": [
        { "if": { "properties": { "signalized": { "const": true } }, "required": ["signalized"] }, "then": { "required": ["signal"] } },
        { "if": { "properties": { "signalized": { "const": false } }, "required": ["signalized"] }, "then": { "not": { "required": ["signal"] } } },
        {
          "if": {
            "properties": {
              "signalized": { "const": true },
              "refuge_island_on_main": { "const": true }
            },
            "required": ["signalized", "refuge_island_on_main"]
          },
          "then": { "required": ["two_stage_tll_control"] },
          "else": { "not": { "required": ["two_stage_tll_control"] } }
        }
      ],
      "description": "十字路イベント。幾何形状はテンプレートで、主道路横断のrefuge islandや制御はイベントごとに指定する。"
    },

    "layoutXwalkMidblock": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "xwalk_midblock", "description": "イベント種別＝単路部歩行者横断" },
        "pos_m": { "type": "number", "minimum": 0, "description": "主道路起点からの位置[m]" },
        "refuge_island_on_main": {
          "type": "boolean",
          "description": "主道路横断に歩行者退避スペース（refuge island）を設けるか"
        },
        "signalized": { "type": "boolean", "description": "信号の有無（箇所ごとに設定）" },
        "two_stage_tll_control": {
          "type": "boolean",
          "description": "refuge island を設けた信号横断で二段階横断信号制御(two-stage TLL)の有無を指定（signalized=true かつ refuge_island_on_main=true の場合のみ必須）"
        },
        "signal": { "$ref": "#/definitions/signalRef" }
      },
      "required": ["type", "pos_m", "signalized", "refuge_island_on_main"],
      "allOf": [
        { "if": { "properties": { "signalized": { "const": true } }, "required": ["signalized"] }, "then": { "required": ["signal"] } },
        { "if": { "properties": { "signalized": { "const": false } }, "required": ["signalized"] }, "then": { "not": { "required": ["signal"] } } },
        {
          "if": {
            "properties": {
              "signalized": { "const": true },
              "refuge_island_on_main": { "const": true }
            },
            "required": ["signalized", "refuge_island_on_main"]
          },
          "then": { "required": ["two_stage_tll_control"] },
          "else": { "not": { "required": ["two_stage_tll_control"] } }
        }
      ],
      "description": "単路部横断イベント。東西どちらのエッジを横断するかは snap.tie_break に従う。refuge island や制御はイベントごとに指定する。"
    }
  }
}
